# 小红书定时发布工具 - 并行开发计划

## 📋 项目概述

将现有的simple版本升级为功能完整、稳定可靠的专业工具，解决GUI卡死问题并实现完整的用户界面。

## 🎯 核心目标

1. **解决卡死问题**：将subprocess.run()替换为QProcess实现真异步
2. **界面功能完整**：实现Excel导入、批量操作、详细任务管理
3. **提升稳定性**：增加异常处理、资源管理、进程安全

## 🏗️ 架构设计

```
GUI层 (PyQt6)
├── 标签页界面 (任务管理 + 账号管理)
├── 控制面板 (文件操作 + 发布控制)
└── 状态监控 (任务详情 + 执行日志)

调度层 (QProcess)
├── 进程管理器 (进程池 + 生命周期管理)
├── 任务调度器 (队列管理 + 状态跟踪)
└── 存储管理器 (原子操作 + 备份恢复)

执行层 (独立进程)
└── 发布脚本 (浏览器操作，完全隔离)
```

## 🔄 并行开发任务分配

### 任务A：核心调度器重构 (优先级：🔴 最高)
**负责人：** 后端开发者  
**预计时间：** 2-3小时  
**依赖：** 无

#### A1. 进程管理器 ✅ (已完成)
- 文件：`core/process_manager.py`
- 功能：QProcess池管理、超时控制、资源清理

#### A2. 调度器重构
- 文件：`core/scheduler.py`
- 重构内容：
  ```python
  # 当前问题代码
  result = subprocess.run(...)  # 阻塞主线程！
  
  # 修改为
  self.process_manager.start_task(task, cmd)  # 真异步
  ```

#### A3. 存储安全增强
- 文件：`core/storage.py`
- 新增功能：
  ```python
  # 原子文件操作
  def save_tasks_atomic(self, tasks):
      # 临时文件 -> 原子替换
      # 自动备份恢复
  ```

**关键修改点：**
1. 移除所有subprocess.run()调用
2. 集成ProcessManager
3. 添加文件锁和原子操作
4. 保持现有信号接口不变

---

### 任务B：界面组件开发 (优先级：🟡 中等)
**负责人：** 前端开发者  
**预计时间：** 3-4小时  
**依赖：** 无 (可与A并行)

#### B1. 控制面板组件
- 文件：`gui/components/control_panel.py`
- 界面设计：
  ```
  [文件操作组]  [发布控制组]  [状态显示组]
  📂导入Excel    🚀发布所有     📊运行状态
  📝添加示例    🛑停止发布     📈任务统计
  🗑️清空任务    🔄刷新状态     💾存储状态
  ```

#### B2. 任务详情表格
- 文件：`gui/components/task_detail_table.py`
- 列设计：
  ```
  标题 | 正文内容 | 图片地址 | 平台 | 发布时间 | 状态 | 最后执行时间 | 操作
  ```

#### B3. 账号管理标签页
- 文件：`gui/components/account_tab.py`
- 功能：登录状态显示、账号切换、登录检测

#### B4. 主界面重构
- 文件：`gui/main_window.py`
- 布局改为：
  ```
  ┌─ 标签页 (任务列表 | 账号管理) ─┐
  ├─ 控制面板 (操作按钮组) ─────┤
  ├─ 任务详情表格 ─┬─ 执行日志 ─┤
  └─────────────┴──────────┘
  ```

**界面要求：**
- 参考目标界面的布局和配色
- 按钮要有颜色区分 (导入=绿色，示例=紫色，清空=红色)
- 表格要支持排序和筛选
- 日志要实时滚动

---

### 任务C：Excel导入功能 (优先级：🟡 中等)
**负责人：** 全栈开发者  
**预计时间：** 2小时  
**依赖：** 任务A (调度器)

#### C1. 异步Excel处理器
- 文件：`gui/components/excel_importer.py`
- 设计：
  ```python
  class AsyncExcelImporter(QObject):
      import_finished = pyqtSignal(bool, list, str)
      
      def import_file(self, file_path):
          # 使用QProcess处理Excel文件
          # 避免阻塞主线程
  ```

#### C2. Excel处理脚本
- 文件：`utils/excel_processor.py`
- 功能：
  ```python
  def process_excel(file_path):
      # 读取Excel
      # 验证数据格式
      # 返回JSON格式任务列表
  ```

#### C3. 示例数据生成
- 功能：生成3个示例任务
- 内容：包含标题、内容、图片路径、发布时间、话题

**Excel格式支持：**
```
标题 | 内容 | 图片路径 | 发布时间 | 话题
```

---

### 任务D：安全机制增强 (优先级：🟠 重要)
**负责人：** 后端开发者  
**预计时间：** 1-2小时  
**依赖：** 任务A (调度器)

#### D1. 操作防护装饰器
- 文件：`utils/operation_guard.py`
- 功能：
  ```python
  @operation_guard("import_excel")
  def import_excel(self):
      # 防止重复操作
  ```

#### D2. 异常处理增强
- 各组件添加try-catch
- 用户友好的错误提示
- 自动恢复机制

#### D3. 资源清理
- 进程退出时清理资源
- 临时文件自动删除
- 内存泄漏预防

---

## 📁 文件修改清单

### 新增文件 (创建)
```
core/process_manager.py          ✅ 已完成
gui/components/control_panel.py      (任务B1)
gui/components/task_detail_table.py  (任务B2)
gui/components/account_tab.py         (任务B3)
gui/components/excel_importer.py      (任务C1)
utils/excel_processor.py             (任务C2)
utils/operation_guard.py             (任务D1)
```

### 修改文件 (重构)
```
core/scheduler.py               (任务A2)
core/storage.py                 (任务A3)
gui/main_window.py             (任务B4)
utils/excel_importer.py        (任务C2改造)
```

## 🔄 开发流程

### 第一轮 (并行开发，2-3小时)
1. **任务A** - 后端重构调度器
2. **任务B** - 前端开发界面组件
3. **任务C** - 全栈实现Excel功能

### 第二轮 (集成测试，1小时)
1. **任务D** - 增强安全机制
2. **集成测试** - 验证所有功能
3. **问题修复** - 解决集成问题

## ✅ 关键检查点

### 阶段1完成标准
- [ ] subprocess.run()完全移除
- [ ] QProcess正常工作
- [ ] 界面不再卡死
- [ ] 基础功能正常

### 阶段2完成标准
- [ ] Excel导入正常工作
- [ ] 界面布局符合设计
- [ ] 所有按钮功能正常
- [ ] 日志实时显示

### 最终交付标准
- [ ] 稳定运行4小时无问题
- [ ] 所有功能完整可用
- [ ] 异常处理完善
- [ ] 性能表现良好

## 🚨 风险控制

### 高风险项目
1. **调度器重构** - 影响核心功能
2. **进程管理** - 可能有内存泄漏
3. **文件操作** - 可能丢失数据

### 风险缓解
1. **分支开发** - 每个任务单独分支
2. **功能开关** - 可以快速回滚到旧版本
3. **充分测试** - 每个阶段完成后立即测试

## 📞 沟通协调

### 接口约定
- ProcessManager信号接口已定义
- 组件间通信使用PyQt信号
- 文件存储格式保持兼容

### 集成点
- 任务A完成后，B和C可以集成
- 所有组件完成后进行最终集成
- 问题反馈通过任务追踪

---

## 🚀 立即行动

1. **分配任务** - 根据团队技能分配A/B/C/D
2. **创建分支** - 每个任务独立Git分支
3. **并行开发** - 同时启动多个任务
4. **定期同步** - 每小时同步一次进度
5. **及时集成** - 完成一个模块立即测试

**预计完成时间：4-6小时**  
**风险等级：低 (架构清晰，模块独立)**  
**成功概率：95%**